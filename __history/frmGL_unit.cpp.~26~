// ---------------------------------------------------------------------------

#include <vcl.h>
#pragma hdrstop

#include "frmGL_unit.h"
// ---------------------------------------------------------------------------
#pragma package(smart_init)
#pragma link "RzPanel"
#pragma link "RzStatus"
#pragma link "RzButton"
#pragma resource "*.dfm"
TfrmGL *frmGL;

// ---------------------------------------------------------------------------
__fastcall TfrmGL::TfrmGL(TComponent* Owner) : TForm(Owner) {
}
// ---------------------------------------------------------------------------

// TForm1::WMPaint(TWMPaint Msg) {
// TPaintStruct ps;
//
// BeginPaint(Handle, &ps);
// Rectangle(Canvas->Handle, 10, 10, 100, 100);
// EndPaint(Handle, &ps);
//
// }

/* =======================================================================
 Формат пикселя */
void __fastcall TfrmGL::SetDCPixelFormat(HDC hdc) {
	PIXELFORMATDESCRIPTOR pfd;
	int nPixelFormat = 0;

	ZeroMemory(&pfd, sizeof(pfd));
	pfd.dwFlags  = PFD_DRAW_TO_WINDOW | PFD_SUPPORT_OPENGL | PFD_DOUBLEBUFFER;
	nPixelFormat = ChoosePixelFormat(hdc, &pfd);
	SetPixelFormat(hdc, nPixelFormat, &pfd);
}

/* =======================================================================
 Создание формы */
void __fastcall TfrmGL::FormCreate(TObject* Sender) {
	hwnd = RzPanel1->Handle;
	dc = GetDC(hwnd);
	SetDCPixelFormat(dc);
	hrc = wglCreateContext(dc);
	Randomize();
	R = Random();
	G = Random();
	B = Random();
}

/* =======================================================================
 Рисование картинки *//* ======================================================================
 Перевод цвета из TColor в OpenGL */
void __fastcall TfrmGL::ColorToGL(TColor c, GLfloat &R, GLfloat &G, GLfloat &B) {
	R = (c & 0xFF) / 255;
	G = ((c & 0xFF00) >> 8) / 255;
	B = ((c & 0xFF0000) >> 16) / 255;
	OutputDebugStringW(IntToStr(R)+"   "+IntToStr(G)+"   "+IntToStr(B));
}

/* =======================================================================
 Конец работы приложения */
void __fastcall TfrmGL::FormDestroy(TObject *Sender) {
	wglDeleteContext(hrc);
}

// ---------------------------------------------------------------------------
void __fastcall TfrmGL::RzToolButton1Click(TObject *Sender) {
	if (ColorDialog1->Execute()) {
		ColorToGL(ColorDialog1->Color, R, G, B);
	}
	RzPanel1->Refresh();
}
// ---------------------------------------------------------------------------
void __fastcall TfrmGL::RzPanel1Paint(TObject *Sender)
{
//	PAINTSTRUCT ps;

	//BeginPaint(hwnd, &ps);
	wglMakeCurrent(dc, hrc);
	glViewport(0, 0, RzPanel1->Width, RzPanel1->Height); // область вывода
	glClearColor(R, G, B, 1.0); // цвет фона
	// glClearColor(0.5, 0.5, 0.75, 1.0); // цвет фона
  	glClear(GL_COLOR_BUFFER_BIT); // очистка буфера цвета
//	glPointSize(20); // размер точек
//	glColor3f(1.0, 0.0, 0.5); // текущий цвет примитивов
//	glBegin(GL_POINTS); // открываем командную скобку
//	glVertex2f(-1, -1);
//	glVertex2f(-1, 1);
//	glVertex2f(0, 0);
//	glVertex2f(1, -1);
//	glVertex2f(1, 1);
//	glEnd();
   	SwapBuffers(dc);
	wglMakeCurrent(0, 0);
   //EndPaint(hwnd, &ps);
}
//---------------------------------------------------------------------------

